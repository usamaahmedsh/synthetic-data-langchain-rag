XNU ("X is Not Unix") is the computer operating system (OS) kernel developed at Apple Inc. since December 1996 for use in the Mac OS X (now macOS) operating system and released as free and open-source software as part of the Darwin OS, which, in addition to being the basis for macOS, is also the basis for iOS, iPadOS, watchOS, visionOS, and tvOS.
XNU was originally developed by NeXT for the NeXTSTEP operating system. It was a hybrid kernel derived from version 2.5 of the Mach kernel developed at Carnegie Mellon University, which incorporated the bulk of the 4.3BSD kernel modified to run atop Mach primitives, along with an application programming interface (API) in Objective-C for writing drivers named DriverKit.
After Apple acquired NeXT, the kernel was updated with code derived from OSF MK 7.3 from OSF, and the FreeBSD project, and the DriverKit was replaced with new API on a restricted subset of C++ (based on Embedded C++) named IOKit.
By keeping the BSD kernel into the third part of XNU, XNU became UNIX-based when macOS achieved UNIX certification under the Single UNIX Specification (SUS) by The Open Group. Despite this, Apple retained the original 'XNU' name, which stands for 'X is Not Unix,' a relic from its NeXTSTEP origins before macOS was UNIX-certified. This has led to confusion, as the name suggests that XNU is separate from UNIX, even though macOS, as a whole, is officially recognized as a UNIX operating system.


== Kernel design ==
XNU is a hybrid kernel, containing features of both monolithic kernels and microkernels, attempting to make the best use of both technologies, such as the message passing ability of microkernels enabling greater modularity and larger portions of the OS to benefit from memory protection, and retaining the speed of monolithic kernels for some critical tasks.
As of 2021, XNU runs on ARM64 and x86-64 processors, both one processor and symmetric multiprocessing (SMP) models. PowerPC support was removed as of the version in Mac OS X Snow Leopard.  Support for IA-32 was removed as of the version in Mac OS X Lion; support for 32-bit ARM was removed as of the version in iOS 11.


=== Mach ===

The basis of the XNU kernel is a heavily modified (hybrid) Open Software Foundation Mach kernel (OSF MK) 7.3. OSF MK 7.3 is a microkernel that includes applicable code from the University of Utah Mach 4 kernel and from the many Mach 3.0 variants forked from the original Carnegie Mellon University Mach 3.0 microkernel.
OSF MK 7.3 is able to run the core of an operating system as separated processes, which allows a great flexibility (it could run several operating systems in parallel above the Mach core), but this often reduces performance because of time-consuming kernel/user mode context switches and overhead stemming from mapping or copying messages between the address spaces of the kernel and that of the service daemons.
Apple licensed OSF MK 7.3 from the OSF, and attempted to streamline some tasks by building BSD functions into the kernel along with the Mach code. The result is a heavily modified (hybrid) OSF MK 7.3 kernel.


=== BSD ===
The Berkeley Software Distribution (BSD) part of the kernel provides the Portable Operating System Interface (POSIX) application programming interface (API, BSD system calls), the Unix process model atop Mach tasks, basic security policies, user and group ids, permissions, the network protocol stack (protocols), the virtual file system code (including a file system independent journaling layer), several local file systems such as Hierarchical File System (HFS, HFS Plus (HFS+)) and Apple File System (APFS), the Network File System (NFS) client and server, cryptographic framework, UNIX System V inter-process communication (IPC), audit subsystem, mandatory access control, and some of the locking primitives. The BSD code present in XNU has been most recently synchronised with that from the FreeBSD kernel. Although much of it has been significantly modified, code sharing still occurs between Apple and the FreeBSD Project as of 2009.


=== K32/K64 ===
XNU in Mac OS X Snow Leopard, v10.6, (Darwin version 10) comes in two varieties, a 32-bit version called K32 and a 64-bit version called K64. K32 can run 64-bit applications in userland. What was new in Mac OS X 10.6 was the ability to run XNU in 64-bit kernel space. K32 was the default kernel for 10.6 Server when used on all machines except Mac Pro and Xserve models from 2008 onwards and can run 64-bit applications.  K64 has several benefits compared to K32:

Can manage more than 32 GB RAM, as the memory map would consume a disproportionately large area of the 32-bit kernel space.
Cache buffer sizes can be larger than what the 32-bit kernel space allows, potentially increasing I/O performance.
Performance is increased when using high-performance networking devices or multiple graphics processing units (GPUs), as the kernel can map all of the devices in 64-bit space even if several have very large direct memory access (DMA) buffers.
Booting while holding down 6 and 4 forces the machine to boot K64 on machines supporting 64-bit kernels. K64 will run 32-bit applications but it will not run 32-bit kernel extensions (KEXTs), so these must be ported to K64 to be able to load.
XNU in OS X Mountain Lion (10.8) and later only provides a 64-bit kernel.


=== IOKit ===
IOKit is the device driver framework, written in a subset of C++ based on Embedded C++. Using its object-oriented design, features common to any class of driver are provided within the framework, helping device drivers be written in less time and code. IOKit is multi-threaded, symmetric multiprocessing (SMP)-safe, and allows for hot-pluggable devices and automatic, dynamic device configuration.
Many drivers can be written to run in user mode, which further enhances the stability of the system. If a driver running in user mode crashes, it will not crash the kernel. However, if a driver running in kernel mode crashes it will crash the kernel. Examples of drivers running in kernel mode include disk adapter and network adapter drivers, graphics drivers, drivers for Universal Serial Bus (USB) and FireWire host controllers, and drivers for virtual machine software such as VirtualBox, Parallels Desktop for Mac, and VMware Fusion. In macOS Catalina and later releases, DriverKit allows some of those types of drivers to run in user mode.


== See also ==

Kernel (operating system)
A/UX
mkLinux
OSF/1
Darwin (operating system) – open source operating system released by Apple, Inc., with XNU as kernel
macOS – operating system released by Apple, Inc., with XNU as kernel


== References ==


== External links ==
xnu on GitHub, official repository
XNU: The Kernel at the Wayback Machine (archived June 2, 2020) – an overview of the components of XNU, written by Amit Singh in December 2003
Inside the Mac OS X Kernel – "This talk intends to clear up the confusion by presenting details of the Mac OS X kernel" (December 2007)