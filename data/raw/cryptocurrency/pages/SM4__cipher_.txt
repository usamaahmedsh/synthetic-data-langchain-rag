ShāngMì 4 (SM4, 商密4) (formerly SMS4) is a block cipher, standardised for commercial cryptography in China. It is used in the Chinese National Standard for Wireless LAN WAPI (WLAN Authentication and Privacy Infrastructure), and with Transport Layer Security.
SM4 was a cipher proposed for the IEEE 802.11i standard, but it has so far been rejected. One of the reasons for the rejection has been opposition to the WAPI fast-track proposal by the IEEE.
SM4 was published as ISO/IEC 18033-3/Amd 1 in 2021.
The SM4 algorithm was drafted by Data Assurance & Communication Security Center, Chinese Academy of Sciences (CAS), and Commercial Cryptography Testing Center, National Cryptography Administration. It is mainly developed by Lü Shuwang (Chinese: 吕述望). The algorithm was declassified in January, 2006, and it became a national standard (GB/T 32907-2016) in August 2016.


== Cipher detail ==
The SM4 cipher has a key size and a block size of 128 bits each. Encryption or decryption of one block of data is composed of 32 rounds. A non-linear key schedule is used to produce the round keys and the decryption uses the same round keys as for encryption, except that they are in reversed order.


=== Keys and key parameters ===
The length of encryption keys is 128 bits, represented as 
  
    
      
        M
        K
        =
        (
        M
        
          K
          
            0
          
        
        ,
         
        M
        
          K
          
            1
          
        
        ,
         
        M
        
          K
          
            2
          
        
        ,
         
        M
        
          K
          
            3
          
        
        )
      
    
    {\displaystyle MK=(MK_{0},\ MK_{1},\ MK_{2},\ MK_{3})}
  
, in which 
  
    
      
        M
        
          K
          
            i
          
        
         
        (
        i
        =
        0
        ,
         
        1
        ,
         
        2
        ,
         
        3
        )
      
    
    {\displaystyle MK_{i}\ (i=0,\ 1,\ 2,\ 3)}
  
 is a 32-bit word. The round keys are represented by 
  
    
      
        (
        r
        
          k
          
            0
          
        
        ,
         
        r
        
          k
          
            1
          
        
        ,
         
        …
        ,
         
        r
        
          k
          
            31
          
        
        )
      
    
    {\displaystyle (rk_{0},\ rk_{1},\ \ldots ,\ rk_{31})}
  
, where each 
  
    
      
        r
        
          k
          
            i
          
        
        (
        i
        =
        0
        ,
         
        …
        ,
         
        31
        )
      
    
    {\displaystyle rk_{i}(i=0,\ \ldots ,\ 31)}
  
 is a word. It is generated by the encryption key and the following parameters:

  
    
      
        F
        K
        =
        (
        F
        
          K
          
            0
          
        
        ,
         
        F
        
          K
          
            1
          
        
        ,
         
        F
        
          K
          
            2
          
        
        ,
         
        F
        
          K
          
            3
          
        
        )
      
    
    {\displaystyle FK=(FK_{0},\ FK_{1},\ FK_{2},\ FK_{3})}
  

  
    
      
        C
        K
        =
        (
        C
        
          K
          
            0
          
        
        ,
         
        C
        
          K
          
            1
          
        
        ,
         
        …
        ,
         
        C
        
          K
          
            31
          
        
        )
      
    
    {\displaystyle CK=(CK_{0},\ CK_{1},\ \ldots ,\ CK_{31})}
  

  
    
      
        F
        
          K
          
            i
          
        
      
    
    {\displaystyle FK_{i}}
  
 and 
  
    
      
        C
        
          K
          
            i
          
        
      
    
    {\displaystyle CK_{i}}
  
 are words, used to generate the round keys.


=== Round ===
Each round are computed from the four previous round outputs 
  
    
      
        
          X
          
            i
          
        
        ,
        
          X
          
            i
            +
            1
          
        
        ,
        
          X
          
            i
            +
            2
          
        
        ,
        
          X
          
            i
            +
            3
          
        
      
    
    {\displaystyle X_{i},X_{i+1},X_{i+2},X_{i+3}}
  
 such that:

  
    
      
        
          X
          
            i
            +
            4
          
        
        =
        
          X
          
            i
          
        
        ⊕
        F
        (
        
          X
          
            i
            +
            1
          
        
        ⊕
        
          X
          
            i
            +
            2
          
        
        ⊕
        
          X
          
            i
            +
            3
          
        
        ⊕
        r
        
          k
          
            i
          
        
        )
      
    
    {\displaystyle X_{i+4}=X_{i}\oplus F(X_{i+1}\oplus X_{i+2}\oplus X_{i+3}\oplus rk_{i})}
  

Where 
  
    
      
        F
      
    
    {\displaystyle F}
  
 is a substitution function composed of  a non-linear transform, the S-box and linear transform 
  
    
      
        L
      
    
    {\displaystyle L}
  


=== S-box ===

SM4's S-box is fixed for 8-bit input and 8-bit output, noted as Sbox(). As with Advanced Encryption Standard (AES), the S-box is based on the multiplicative inverse over GF(28). The affine transforms and polynomial bases are different from that of AES, but due to affine isomorphism it can be calculated efficiently given an AES S-Box.


== History ==
On March 21, 2012, the Chinese government published the industrial standard "GM/T 0002-2012 SM4 Block Cipher Algorithm", officially renaming SMS4 to SM4.
A description of SM4 in English is available as an Internet Draft. It contains a reference implementation in ANSI C.
SM4 is part of the ARMv8.4-A expansion to the ARM architecture. SM4 support for the RISC-V architecture was ratified in 2021 as the Zksed extension.
SM4 is supported by Intel processors, starting from Arrow Lake S, Lunar Lake,  Diamond Rapids and Clearwater Forest.


== References ==


== External links ==
Linear and Differential Cryptanalysis of Reduced SMS4 Block Cipher
Example of SMS4 implemented as a Spreadsheet
Page of Lu Shu-wang (吕述望) (in Chinese)
The GmSSL Project Archived 2020-10-21 at the Wayback Machine (OpenSSL fork with GuoMi algorithms)
[1] (ISO/IEC 18033-3:2010/Amd 1:2021 Information technology — Security techniques — Encryption algorithms — Part 3: Block ciphers — Amendment 1: SM4 )